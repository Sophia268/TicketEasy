name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.0.0
        with:
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      - name: Install .NET Android workload
        run: dotnet workload install android

      - name: Get Version
        id: get_version
        shell: bash
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          CLEAN_VERSION="${TAG_NAME#v}"
          echo "VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Decode Android keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p RegistrationEasy.Android
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > RegistrationEasy.Android/ci-release.keystore

      - name: Publish signed Android APK
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          dotnet publish RegistrationEasy.Android/RegistrationEasy.Android.csproj \
            -c Release \
            -f net10.0-android \
            -p:AndroidKeyStore=true \
            -p:AndroidSigningKeyStore=ci-release.keystore \
            -p:AndroidSigningStorePass=$ANDROID_KEYSTORE_PASSWORD \
            -p:AndroidSigningKeyAlias=$ANDROID_KEY_ALIAS \
            -p:AndroidSigningKeyPass=$ANDROID_KEY_PASSWORD

      - name: Locate and rename APK
        shell: bash
        run: |
          APK_PATH=$(find RegistrationEasy.Android/bin/Release -name "*-Signed.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find RegistrationEasy.Android/bin/Release -name "*.apk" | head -n 1)
          fi
          if [ -z "$APK_PATH" ]; then
            echo "No APK found" >&2
            exit 1
          fi
          APK_NAME="RegistrationEasy-Android-${{ steps.get_version.outputs.TAG_NAME }}.apk"
          cp "$APK_PATH" "$APK_NAME"

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: ./*.apk

  release:
    needs:
      - android
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Display structure of downloaded files
        run: ls -R

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android/*.apk
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Update 'latest' Release
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the APK file from the artifacts
          SOURCE_APK=$(ls android/*.apk | head -n 1)

          if [ -z "$SOURCE_APK" ]; then
            echo "No APK found to publish as latest!"
            exit 1
          fi

          echo "Found source APK: $SOURCE_APK"

          # Define the fixed name for the latest release (Must match the URL requirement)
          LATEST_APK="android/TicketEasy-Android-latest.apk"

          # Copy source to latest filename
          cp "$SOURCE_APK" "$LATEST_APK"

          # Delete existing 'latest' release and tag if they exist
          echo "Deleting old 'latest' release..."
          gh release delete latest --repo ${{ github.repository }} --cleanup-tag -y || echo "No existing 'latest' release to delete."
          
          # Create new 'latest' release pointing to current commit
          echo "Creating new 'latest' release..."
          gh release create latest "$LATEST_APK" \
            --repo ${{ github.repository }} \
            --title "Latest Build" \
            --notes "This release always contains the latest build artifacts. Currently updated from ${GITHUB_REF_NAME}." \
            --target $GITHUB_SHA \
            --prerelease=false \
            --latest=false
